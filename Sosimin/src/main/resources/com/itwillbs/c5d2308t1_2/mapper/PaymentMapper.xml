<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.c5d2308t1_2.mapper.PaymentMapper">
	<!-- 토큰 아이디조회 -->
	<select id="selectAccessToken" resultType="map">
		SELECT *
		FROM Token
		WHERE member_id = #{member_id}
	</select>

	<!-- 엑세스 토큰 저장 - INSERT -->
	<insert id="insertAccessToken">
		INSERT INTO Token
		VALUES (
			null
			, #{member_id}
			, #{token.access_token} 
			, #{token.refresh_token} 
			, #{token.user_seq_no} 
			, null
		)
	</insert>

	<!-- 엑세스 토큰 업데이트 - UPDATE -->
	<update id="updateAccessToken">
		UPDATE Token
		SET 
			access_token = #{token.access_token}
			, refresh_token = #{token.refresh_token}
			, user_seq_no = #{token.user_seq_no}
		WHERE member_id = #{member_id}
	</update>
	
	<!-- 페이 아이디조회 -->
	<select id="selectPay" resultType="int">
		SELECT count(*)
		FROM Pay
		WHERE member_id = #{member_id}
	</select>
	
	<!-- 페이 가입 - INSERT -->
	<insert id="insertPay">
		INSERT INTO Pay
		VALUES (
			null
			, #{member_id}
			, #{user_name}
			, #{fintech_use_num}
			, #{bank_name}
			, #{account_num_masked}
			, 0
			, now()
			, 1
			, null
			, #{pay_password}
		)
	</insert>
	
	<select id="selectPayInfo" resultType="map">
		SELECT *
		FROM Pay
		WHERE member_id = #{member_id}
			AND pay_status = 1
	</select>
	
	<!-- 페이 내역 불러오기(연도별 그룹화) -->
<!-- 	<select id="selectPayHistoryByYear" resultType="map"> -->
<!-- 		SELECT YEAR(pay_history_date) AS year, -->
<!-- 			JSON_ARRAYAGG( -->
<!-- 				JSON_OBJECT( -->
<!-- 					'pay_history_id', pay_history_id, -->
<!-- 		            'pay_id', pay_id, -->
<!-- 		            'pay_amount', pay_amount, -->
<!-- 		            'pay_history_balance', pay_history_balance, -->
<!-- 		            'pay_history_type', pay_history_type, -->
<!-- 		            'order_id', order_id, -->
<!-- 		            'pay_history_date', pay_history_date, -->
<!-- 		            'pay_history_state', pay_history_state, -->
<!-- 		            'pay_cancel_date', pay_cancel_date -->
<!-- 				) -->
<!-- 			) AS list -->
<!-- 		FROM PayHistory -->
<!-- 		WHERE pay_id = 2 -->
<!-- 		<if test="pay_history_type != null and !pay_history_type.equals('')"> -->
<!-- 			AND pay_history_type = #{pay_history_type} -->
<!-- 		</if> -->
<!-- 		GROUP BY YEAR(pay_history_date) -->
<!-- 		ORDER BY year DESC -->
<!-- 		LIMIT #{startRow}, #{listLimit} -->
<!-- 	</select> -->

	<select id="selectPayHistory" resultType="map">
		SELECT *
		FROM PayHistory
		WHERE pay_id = #{pay_id}
		ORDER BY pay_history_date DESC
	</select>
	
	<!-- 페이 내역 개수 세기(페이징) -->
	<select id="selectPayHistoryCount" resultType="map">
		SELECT COUNT(*)
		FROM PayHistory
		WHERE pay_id = #{pay_id}
		<if test="pay_history_type != null and !pay_history_type.equals('')">
			AND pay_history_type = #{pay_history_type}
		</if>
	</select>
	
	<!-- 페이 잔액 충전 -->
	<update id="updatePay">
		UPDATE Pay
		SET pay_balance = pay_balance + CAST(#{tran_amt} AS SIGNED)
		WHERE fintech_use_num = #{fintech_use_num}	
	</update>
	
	<insert id="insertPayHistory">
		<selectKey keyProperty="pay_history_balance" resultType="INT" order="BEFORE">
			SELECT pay_balance
			FROM Pay
			WHERE pay_id = #{pay_id}
		</selectKey>
		INSERT INTO PayHistory
		VALUE (
			null
			, #{pay_id}
			, #{tran_amt}
			, #{pay_history_balance} + CAST(#{tran_amt} AS SIGNED)
			, 1 -- 충전
			, null -- 상품관련아님
			, now()
			, 1 -- 완료
			, null
		)
	</insert>
	
	
	
	<!-- ================ 관리자페이지 ====================== -->
	<select id="selectPayHistoryAll" resultType="map">
		SELECT *
		FROM PayHistory
	</select>
	
	
</mapper>